<!DOCTYPE html>
<html>
<head>
<title>Live Streaming TV</title>
<script src="js/hls.js"></script>
<script src="js/jquery.js"></script>
<script>
  function selectChannel() {
    var checked = $('#channel_list [name=ch]:checked');
    if (checked.length == 1) {
      $.ajax({
        type: 'POST',
        url: 'channels/select',
        cache: false,
        data: { ch: checked.val() }
      });
    }
  }
  function capture() {
    var v = document.getElementById('video');
    var c = document.createElement('canvas');
    var ctx = c.getContext('2d');
    c.width = v.videoWidth;
    c.height = v.videoHeight;
    ctx.drawImage(v, 0, 0);
    $.ajax({
      type: 'POST',
      url: 'tweet',
      cache: false,
      data: { url: c.toDataURL() },
      success: function() {
        c.remove();
      }
    });
  }
  function getCurrentChannel() {
    $.ajax({
      type: 'GET',
      url: 'channels/current',
      cache: false,
      success: function(json) {
        document.getElementById(json[1]).checked = true;
      }
    });
  }
  function bind() {
    $(window).keyup(function(e) {
      if (e.keyCode == 84) {
        this.capture();
      }
    });
  }
</script>
</head>
<body onload="bind()">
<video controls autoplay id="video" width="100%"></video>
<script>
  if (Hls.isSupported()) {
    var video = document.getElementById('video');
    var hls = new Hls();
    hls.loadSource('hls/stream.m3u8');
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, function() {
      video.play();
    });
  }
  $.ajax({
    type: 'GET',
    url: 'channels',
    success: function(channels) {
      var channel_list = $('#channel_list');
      for (var i in channels) {
        var input = $('<input>');
        input.attr('type', 'radio');
        input.attr('name', 'ch');
        input.attr('id', channels[i].channel_number);
        input.attr('value', channels[i].channel_number);
        var label = $('<label>');
        label.attr('for', channels[i].channel_number);
        label.text(channels[i].name);
        input.appendTo(channel_list);
        label.appendTo(channel_list);
      }
      getCurrentChannel();
    }
  });
</script>
<form id="channel_list" name="channel_list">
</form>
<input type="button" id="channel_select" onclick="selectChannel()" value="SELECT">
</body>
</html>
